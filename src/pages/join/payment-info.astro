---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { stytch } from "src/lib/stytch";
import { swell } from "src/lib/swell";
import { PaymentInfoForm } from "src/components/solid/PaymentInfoForm";

// Redirect if not logged in
const sessionToken = Astro.cookies.get("gp_session_token")?.value as string;
const session = sessionToken
  ? await stytch.sessions.authenticate({
      session_token: sessionToken,
    })
  : null;

if (!session) {
  return Astro.redirect("/join");
}

// Redirect if account isn't created yet or billing info is already set
const email = session?.user.emails[0]?.email as string;
const account = await swell.get(`/accounts/${email}`);

if (!account) {
  return Astro.redirect("/join/personal-info");
} else if (
  account.billing?.card &&
  Object.keys(account.billing?.card).length !== 0
) {
  return Astro.redirect(
    "/?message=" + encodeURIComponent("Onboarding complete!"),
  );
}
---

<AuthLayout title="Goodpluck | Join">
  <h1
    id="create-account-title"
    class="text-3xl mt-4 mb-10 font-semibold text-gray-900 text-center"
  >
    Create an account to place your orders!
  </h1>
  <div
    role="progressbar"
    aria-valuenow="33"
    aria-valuemin="0"
    aria-valuemax="100"
    aria-label="Account creation progress: 33% complete."
    class="w-full bg-gray-300 rounded-full h-1.5 my-8"
  >
    <div class="bg-green-700 h-1.5 rounded-full w-1/3"></div>
  </div>
  <PaymentInfoForm client:load />
</AuthLayout>
