---
import { StytchError } from "stytch";
import { stytch, isLoggedIn } from "../../lib/stytch";
import Layout from "../../layouts/Layout.astro";
import { CONFIRMED_ZIPCODES } from "../../lib/constants";

const errors = { email: "" };
let email;

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    email = data.get("email")?.toString();
    const zipcode = data.get("zipcode")?.toString();

    if (!email) {
      errors.email = "Email is required";
    } else if (!zipcode) {
      errors.email = "ZIP code is required";
    } else if (zipcode && !CONFIRMED_ZIPCODES.includes(zipcode)) {
      return Astro.redirect(
        `/waitlist?zipcode=${zipcode}&email=${encodeURIComponent(email)}`,
      );
    } else {
      try {
        const response = await stytch.otps.email.loginOrCreate({
          email,
          expiration_minutes: 10,
        });

        console.log(response);

        if (response.user_created) {
          // New user created, proceed with signup
          return Astro.redirect("/join/code?method_id=" + response.email_id);
        } else {
          // User already exists, redirect to login-code with a message
          return Astro.redirect(
            "/login-code?method_id=" + response.email_id + "&user_exists=true",
          );
        }
      } catch (error) {
        console.log(error);
        if (error instanceof StytchError) {
          errors.email = error.message;
        } else {
          errors.email = "Something went wrong, please try again later";
        }
      }
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}

// Redirect authenticated users away from join page
const sessionToken = Astro.cookies.get("gp_session_token")?.value;
const isUserLoggedIn = sessionToken && !!(await isLoggedIn(sessionToken));

if (isUserLoggedIn) {
  return Astro.redirect("/join/personal-info");
}
---

<Layout title="Goodpluck">
  <div class="flex flex-col py-40 w-full sm:w-[400px] mx-auto">
    <h1 class="text-4xl font-bold text-gray-900 mb-6 text-center">
      Create an account to get started
    </h1>
    <form method="POST" class="w-60 mx-auto py-8">
      <label for="email">What's your email</label>
      <input
        type="email"
        id="email"
        name="email"
        placeholder="kale@example.com"
        required
        class="border rounded-md p-2 w-full mb-8"
        value={email}
      />
      <label for="zipcode">Confirm your zip</label>
      <input
        type="text"
        id="zipcode"
        name="zipcode"
        pattern="^[0-9]{5}(-[0-9]{4})?$"
        placeholder="48201"
        required
        class="border rounded-md p-2 w-full mb-4"
        title="Enter a 5-digit ZIP code or a 9-digit ZIP+4 code."
        maxlength="10"
      />
      {errors.email && <p class="text-red-400">{errors.email}</p>}
      <button
        class="px-6 py-4 w-full mt-8 bg-brand-yellow border-2 border-black text-center font-bold rounded shadow-md hover:bg-yellow-400"
        id="submit-join-code-btn"
        type="submit">Create Account</button
      >
    </form>
    <p class="mt-6 text-sm text-center text-gray-600">
      You already have an account? <a
        href="/login"
        class="text-orange-500 hover:underline">Log in</a
      >
    </p>
  </div>
</Layout>
