---
import MapboxAutofill from "../components/solid/MapboxAutofill";
import { isLoggedIn, stytch } from "../lib/stytch";
import Layout from "@layouts/Layout.astro";
import { swell } from "src/lib/swell";

const errors = { err: "" };

const mapboxToken = import.meta.env.MAPBOX_DEFAULT_PUBLIC_TOKEN;

// Redirect unauthenticated users to the login page
const sessionToken = Astro.cookies.get("gp_session_token")?.value;
const isUserLoggedIn = sessionToken && !!(await isLoggedIn(sessionToken));

if (!isUserLoggedIn) {
  return Astro.redirect(
    "/?message=" + encodeURIComponent("You are not logged in"),
  );
}

// Redirect users who already have a Swell account
const session = await stytch.sessions.authenticate({
  session_token: Astro.cookies.get("gp_session_token")?.value,
});
const email = session.user.emails[0].email;
const account = await swell.get(`/accounts/${email}`);

if (account) {
  return Astro.redirect(
    "/?message=" + encodeURIComponent("Onboarding complete!"),
  );
}

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const first_name = data.get("first_name")?.toString();
    const last_name = data.get("last_name")?.toString();
    const phone = data.get("phone_number")?.toString();
    const consent = data.get("consent");
    const address1 = data.get("address address-search")?.toString();
    const city = data.get("city")?.toString();
    const state = data.get("state")?.toString();
    const postcode = data.get("postcode")?.toString();
    const apartment = data.get("apartment")?.toString(); // Optional

    if (
      !first_name ||
      !last_name ||
      !phone ||
      !address1 ||
      !consent ||
      !city ||
      !state ||
      !postcode
    ) {
      errors.err = "Please fill all the fields";
    } else {
      // Create user account on Swell
      await swell.post("/accounts", {
        email: session.user.emails[0].email,
        first_name,
        last_name,
        shipping: {
          address1,
          address2: apartment,
          city,
          state,
          zip: postcode,
        },
        phone: phone,
        email_optin: consent === "on",
        type: "individual",
      });

      return Astro.redirect(
        "/?message=" + encodeURIComponent("Onboarding complete!"),
      );
    }
  } catch (error) {
    console.log(error);
    errors.err = "Something went wrong, please try again";
  }
}
---

<Layout>
  <div>
    <h2 class="text-2xl font-bold text-gray-900 my-6 text-center">
      Let's complete your informations
    </h2>
    <p class="text-center">
      We need some informations to complete your account. Let's complete it
      before you can make your first order!
    </p>

    <p class="text-center text-red-500 mt-4">{errors.err}</p>

    <div class="flex flex-col mt-12 w-1/2 ml-10">
      <form method="POST">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your first name</label
        >
        <input
          type="text"
          name="first_name"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your last name</label
        >
        <input
          type="text"
          name="last_name"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your phone number</label
        >
        <input
          type="text"
          name="phone_number"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <h3>Your delivery address</h3>

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your address</label
        >
        <input
          type="text"
          name="address"
          required
          autocomplete="address-line1"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your apartment</label
        >
        <input
          type="text"
          name="apartment"
          autocomplete="address-line2"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your city</label
        >
        <input
          type="text"
          name="city"
          required
          autocomplete="address-level2"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your postal code</label
        >
        <input
          type="text"
          name="postcode"
          required
          autocomplete="postal-code"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your state</label
        >
        <input
          type="text"
          name="state"
          required
          autocomplete="address-level1"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >I consent to receive order updates and other communications to the
          provided phone number</label
        >
        <input
          type="checkbox"
          name="consent"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />
        <button
          class="bg-blue-500 text-white rounded-md p-2 w-full mb-2 hover:bg-blue-600"
          type="submit">Submit</button
        >
      </form>
    </div>
  </div>

  <MapboxAutofill client:only mapboxToken={mapboxToken} />
</Layout>
