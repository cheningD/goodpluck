---
import MapboxAutofill from "../components/solid/MapboxAutofill";
import { getStytchClient, isLoggedIn } from "../lib/stytch";
import Layout from "@layouts/Layout.astro";

const errors = { err: "" };

const runtime = Astro.locals.runtime;
const mapboxToken = runtime
  ? runtime.env.MAPBOX_DEFAULT_PUBLIC_TOKEN
  : import.meta.env.MAPBOX_DEFAULT_PUBLIC_TOKEN;
const { STYTCH_PROJECT_ID, STYTCH_PROJECT_SECRET } =
  runtime?.env || import.meta.env;

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const first_name = data.get("first_name")?.toString();
    const last_name = data.get("last_name")?.toString();
    const phone_number = data.get("phone_number");
    const address = data.get("address address-search")?.toString();
    const consent = data.get("consent");

    const name = { first_name, last_name };
    const untrusted_metadata = { address, consent, phone_number };

    if (!first_name || !last_name || !phone_number || !address || !consent) {
      errors.err = "Please fill all the fields";
    } else {
      // handle Stytch API calls to get the user_id with the session token in order to authenticate the request.
      const sessionToken = Astro.cookies.get("gp_session_token");

      const stytchclient = getStytchClient(
        STYTCH_PROJECT_ID,
        STYTCH_PROJECT_SECRET,
      );

      const session = stytchclient.sessions.authenticate({
        session_token: sessionToken?.value,
      });
      const sessionData = await session;
      const userId = sessionData.user.user_id;

      try {
        await stytchclient.users.update({
          user_id: userId,
          name,
          untrusted_metadata,
        });

        return Astro.redirect("/");
      } catch (error) {
        console.log(error);
        errors.err = "An error occured, please try again";
      }
    }
  } catch (error) {}
}

// Redirect unauthenticated users to the login page
const sessionToken = Astro.cookies.get("gp_session_token")?.value;
const isUserLoggedIn = await isLoggedIn(
  sessionToken as string,
  STYTCH_PROJECT_ID,
  STYTCH_PROJECT_SECRET,
);

if (!isUserLoggedIn) {
  return Astro.redirect(
    "/?message=" + encodeURIComponent("You are not logged in"),
  );
}
---

<Layout>
  <div>
    <h2 class="text-2xl font-bold text-gray-900 my-6 text-center">
      Let's complete your informations
    </h2>
    <p class="text-center">
      We need some informations to complete your account. Let's complete it
      before you can make your first order!
    </p>

    <p class="text-center text-red-500 mt-4">{errors.err}</p>

    <div class="flex flex-col mt-12 w-1/2 ml-10">
      <form method="POST">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your first name</label
        >
        <input
          type="text"
          name="first_name"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your last name</label
        >
        <input
          type="text"
          name="last_name"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your phone number</label
        >
        <input
          type="text"
          name="phone_number"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <h3>Your delivery address</h3>

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your address</label
        >
        <input
          type="text"
          name="address"
          required
          autocomplete="address-line1"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your appartment</label
        >
        <input
          type="text"
          name="appartment"
          autocomplete="address-line2"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your city</label
        >
        <input
          type="text"
          name="city"
          required
          autocomplete="address-level2"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your postal code</label
        >
        <input
          type="text"
          name="postcode"
          required
          autocomplete="postal-code"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Your state</label
        >
        <input
          type="text"
          name="state"
          required
          autocomplete="address-level1"
          class="border rounded-md p-2 w-1/2 mb-4"
        />

        <label class="block text-sm font-medium text-gray-700 mb-2"
          >I consent to receive order updates and other communications to the
          provided phone number</label
        >
        <input
          type="checkbox"
          name="consent"
          required
          class="border rounded-md p-2 w-1/2 mb-4"
        />
        <button
          class="bg-blue-500 text-white rounded-md p-2 w-full mb-2 hover:bg-blue-600"
          type="submit">Submit</button
        >
      </form>
    </div>
  </div>

  <MapboxAutofill client:only mapboxToken={mapboxToken} />
</Layout>
