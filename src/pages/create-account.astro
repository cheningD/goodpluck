---
import Banner from '../components/solid/Banner.tsx';
import Cart from '../components/solid/Cart.tsx';
import Menu from '../components/solid/Menu';
import MobileNav from '../components/solid/MobileNav.tsx';
import { stytch } from '../lib/stytch';

const errors = { err: '' };

if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData();
    const first_name = data.get('first_name')?.toString();
    const last_name = data.get('last_name')?.toString();
    const phone_number = data.get('phone_number');
    const address = data.get('address');
    const consent = data.get('consent');

    const name = { first_name, last_name };
    const untrusted_metadata = { address, consent, phone_number };

    if (!first_name || !last_name || !phone_number || !address || !consent) {
      errors.err = 'Please fill all the fields';
    } else {
      // handle Stytch API calls to get the user_id with the session token in order to authenticate the request.
      const sessionToken = Astro.cookies.get('gp_session_token');

      const session = stytch.sessions.authenticate({
        session_token: sessionToken?.value,
      });
      const sessionData = await session;
      const userId = sessionData.user.user_id;

      try {
        const response = await stytch.users.update({
          user_id: userId,
          name,
          untrusted_metadata,
        });

        // TODO: handle a success/error message and a smooth transition

        Astro.redirect('/');
      } catch (error) {
        console.log(error);
      }
    }
  } catch (error) {}
}
---

<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <link rel='icon' type='image/svg+xml' href='/favicon.svg' />
    <meta name='viewport' content='width=device-width' />
    <meta name='generator' content={Astro.generator} />
    <title>Create your account - Goodpluck</title>
  </head>

  <body>
    <div class='sticky top-0 h-full'>
      <Banner client:load />
      <MobileNav client:load />
    </div>
    <Cart client:load />
    <Menu client:load />

    <div>
      <h2 class='text-2xl font-bold text-gray-900 my-6 text-center'>
        Let's complete your informations
      </h2>
      <p class='text-center'>
        We need some informations to complete your account. Let's complete it
        before you can make your first order!
      </p>

      <div class='flex flex-col mt-12 w-1/2 ml-10'>
        <form method='POST'>
          <label class='block text-sm font-medium text-gray-700 mb-2'
            >Your first name</label
          >
          <input
            type='text'
            name='first_name'
            required
            class='border rounded-md p-2 w-1/2 mb-4'
          />

          <label class='block text-sm font-medium text-gray-700 mb-2'
            >Your last name</label
          >
          <input
            type='text'
            name='last_name'
            required
            class='border rounded-md p-2 w-1/2 mb-4'
          />

          <label class='block text-sm font-medium text-gray-700 mb-2'
            >Your phone number</label
          >
          <input
            type='text'
            name='phone_number'
            required
            class='border rounded-md p-2 w-1/2 mb-4'
          />

          <label class='block text-sm font-medium text-gray-700 mb-2'
            >Your delivery address</label
          >
          <input
            type='text'
            name='address'
            required
            class='border rounded-md p-2 w-1/2 mb-4'
          />

          <label class='block text-sm font-medium text-gray-700 mb-2'
            >I consent to receive order updates and other communications to the
            provided phone number</label
          >
          <input
            type='checkbox'
            name='consent'
            required
            class='border rounded-md p-2 w-1/2 mb-4'
          />
          <button
            class='bg-blue-500 text-white rounded-md p-2 w-full mb-2 hover:bg-blue-600'
            type='submit'>Submit</button
          >
        </form>
      </div>
    </div>
  </body>
</html>
