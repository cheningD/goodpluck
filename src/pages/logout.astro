---
import { getStytchClient } from "../lib/stytch";

let message = "";
const session_token = Astro.cookies.get("gp_session_token")?.value;
const runtime = Astro.locals.runtime;
const { STYTCH_PROJECT_ID, STYTCH_PROJECT_SECRET } =
  runtime?.env || import.meta.env;

if (session_token) {
  try {
    const stytchclient = getStytchClient(
      STYTCH_PROJECT_ID,
      STYTCH_PROJECT_SECRET,
    );
    await stytchclient.sessions.revoke({ session_token });
    Astro.cookies.delete("gp_session_token");
    message = `successLoggingOut`;
  } catch (e) {
    console.error("Error during session revocation:", e);
    message = "errorLoggingOut";
  }
} else {
  message = "errorNotLoggedIn";
}

// Redirection occurs regardless of the above conditions
return Astro.redirect("/?message=" + message);
---
